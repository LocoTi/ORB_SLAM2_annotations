# LoopClosing线程

LoopClosing的就是闭环的意思，检测新出现的关键帧是否回到了某个之前到过的地方，如果检测出闭环，则可以对其进行一些优化，对跟踪时的累积误差进行纠正，以至不会产生越来越大的偏差。

LoopClosing线程和LocalMapping类似，系统启动后一直处于后台运行状态，等待LocalMapping线程中mpLoopCloser->InsertKeyFrame(mpCurrentKeyFrame)将新关键帧加入到闭环检测队列中。Loopclosing中的关键帧是LocalMapping发送过来的，LocalMapping是Tracking中发过来的。通过不停循环查看闭环检测队列中是否有新关键帧，有则进行主要三个步骤：检测闭环、计算相似变换，闭环矫正。没有则暂停一段时间过后继续检查队列。



### 1、闭环检测DetectLoop

从队列中取出一个关键帧,作为当前检测闭环关键帧，判断是否进行闭环检测，如果距离上次闭环没多久（小于10帧），或者map中关键帧总共还没有10帧，则不进行闭环检测。

获取当前帧的共视关键帧，遍历所有共视关键帧，计算当前关键帧与每个共视关键的bow相似度得分，并得到最低得分minScore。minScore的作用：认为和当前关键帧具有回环关系的关键帧,不应该低于当前关键帧的相邻关键帧的最低的相似度minScore。

在关键帧数据库中找到闭环候选帧：



