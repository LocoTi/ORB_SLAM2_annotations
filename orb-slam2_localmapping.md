# LocalMapping线程

LocalMapping线程在系统启动后就一直在后台运行，从系统架构图中可以看到，Tracking线程处理完之后，会将关键帧插入到列表 mlNewKeyFrames中。LocalMapping线程就会循环检查这个mlNewKeyFrames列表，如果有新的关键帧，就取出来进行处理。如果没有，则线程会等待一段时间，后继续检查。

LocalMapping的字面意思是“局部建图”，这里指的是新的关键帧周围的地图（主要是共视关键帧和地图点），相对与全局地图来说新的关键帧周围的地图就是局部地图。

### 1、ProcessNewKeyFrame处理列表中最新的关键帧

从列表中取出一帧关键帧。计算该关键帧特征点的Bow映射关系。

关联MapPoints到新的关键帧并且更新描述子，因为Tracking线程只是添加地图点到关键帧，没有关联（即没有添加观测）。遍历新关键帧的地图点，判断每个地图点的关键帧观测列表（能观测到当前地图点的所有关键帧组成的map）中有没有新的关键帧。

如果没有的话对地图点做下面三项处理：

1）将新关键帧加入到地图点观测列表

2）更新该点的平均观测方向和观测距离范围

3）加入关键帧后，更新3d点的最佳描述子。最有代表性的描述子，它与其他描述子应该具有最小的距离中值，这里的距离中值也就相当于和其他描述子平均距离。

如果有的话（这种情况仅出现在通过Tracking线程插入的双目地图点，也就是说对于单目不可能出现）：

​	将该地图点加入到mlpRecentAddedMapPoints列表当中；

更新关键帧间的连接关系，Covisibility图和Essential图(tree)。

将该关键帧插入到地图中mpMap->AddKeyFrame(mpCurrentKeyFrame)。



### 2、对地图点进行剔除MapPointCulling

所有新增的地图点都会添加到mlpRecentAddedMapPoints，在这里剔除一些不靠谱的。

遍历检查新添加的地图点，提出一些不满足的点：

1）已经是坏点的地图点从mlpRecentAddedMapPoints队列删除

2）跟踪到该地图点的帧数相比预计可观测到该地图点的帧数的比例小于25%，从地图中删除，pMP->SetBadFlag()。(mnFound/mnVisible） < 25%。

mnFound ：地图点被多少帧（包括普通帧）看到，有匹配的特征点。

mnVisible：地图点应该被看到的次数。MapPoint在帧的视野范围内，通过Frame::isInFrustum()函数判断，但是并不一定有匹配的特征点。

3）从该点建立开始，到现在已经过了不小于2个关键帧，但是观测到该点的帧数数却不超过阈值cnThObs，从地图中删除，pMP->SetBadFlag()。

4）从建立该点开始，已经过了3个关键帧而没有被剔除，则认为是质量高的点。因此没有SetBadFlag()，仅从队列中删除。



### 3、创建地图点CreateNewMapPoints

在当前关键帧的共视关键帧中找到共视程度最高的nn（单目是20）帧相邻帧vpNeighKFs

取出当前帧从世界坐标系到相机坐标系的变换矩阵，得到当前关键帧（左目）光心在世界坐标系中的坐标，内参。

遍历相邻关键帧，取得相邻的关键帧光心在世界坐标系中的坐标，计算基线向量，即两个关键帧间的相机位移，判断相机运动的基线是不是足够长：

​	如果是双目相机，关键帧间距小于本身的基线时不生成3D点

​	单目情况下，计算基线和场景深度中值之比，如果<0.01则不能进行三角化；

根据两个关键帧的位姿计算它们之间的基础矩阵ComputeF12(mpCurrentKeyFrame,pKF2)，

用对极约束来查找当前关键帧和遍历关键帧之间满足对极约束关系的特征点，并利用Bow进行加速特征点匹配（SearchForTriangulation）；

遍历上面两个关键帧之间匹配的特征点，通过三角化创建地图点。并添加地图点的观测帧、将地图点插入到当前关键帧和遍历关键帧的地图点列表中、计算地图点的描述子、更新地图点的深度、将地图点加入到地图当中；  

将新产生的地图点放入检测队列，这些MapPoints都会经过MapPointCulling函数的检验。



### 4、检查并融合当前关键帧与相邻帧（两级相邻）重复的地图点SearchInNeighbors

获得当前新关键帧共视图中权重排名前nn的共视关键帧（一级相邻关键帧），以及这些共视关键帧的共视关键帧(最多5个)。

4.1、遍历上述关键帧，将当前新关键帧的地图点分别投影到这些关键帧，寻找匹配点对应的地图点进行融合，称为正向投影融合：

a）遍历当前新关键帧的地图点，对每一个地图点计算其遍历关键帧的相素投影坐标，并判断所计算的像素坐标是否在关键帧当中，不在则继续遍历下一个地图点，在则执行b）操作；

b）判断地图点到关键帧相机光心距离（地图点的深度）需满足在有效范围内，不满足的继续遍历下一个地图点，满足则执行c）操作；

c）判断地图点到光心的连线与该地图点的平均观测向量之间夹角要小于60°，不满足的继续遍历下一个地图点，满足则执行d）操作；

d）在投影点附近搜索窗口内找到候选匹配点，获得候选匹配点的索引，如果为空则继续遍历下一个地图点，不为空则执行e）操作；

e）遍历找到的候选匹配点，计算重投影误差，如果误差在一定范围内（单目5.99，非单目7.8），则继续比较描述子的距离，描述子距离最小的特征点为最佳匹配点；

f）最佳匹配距离要小于阈值，则找到投影点对应的最佳匹配特征点，且找到该匹配特征点的地图点。

如果找到地图点，且地图点是OK的，如果找到的最佳地图点的观测数大于当前遍历地图点的观测数，则用查找到的地图点替换当前地图点，否则用当前地图点替换查找到的地图点；

如果佳匹配特征点没有对应地图点，则添加观测信息，且将地图点添加到当前遍历关键帧中。

4.2、遍历上述关键帧，将每个关键帧地图点分别投影到当前关键帧，寻找匹配点对应的地图点进行融合，称为反向投影融合。

更新当前帧地图点信息，遍历当前帧的地图点，计算所有能观测到该地图点的描述子，得到最佳的描述子。更新地图点的平均观测方向和观测距离。

更新当前帧与其它帧的共视连接关系



### 5、和当前关键帧相连的关键帧及MapPoints做局部BA优化（Optimizer::LocalBundleAdjustment）

优化对象包括局部关键帧和局部地图点。

局部关键帧：当前关键帧及其共视关键帧

局部地图点：局部关键帧所有关键帧观察到的地图点



### 6、局部地图关键帧剔除KeyFrameCulling

检测并剔除当前帧相邻的关键帧中冗余的关键帧。

剔除的标准是：该关键帧的90%的MapPoints可以被其它关键帧观测到

遍历当前关键帧的所有共视关键帧。提取每个共视关键帧的MapPoints，遍历该关键帧的MapPoints，判断是否90%以上的MapPoints能被其它关键帧（至少3个）观测到。该关键帧90%以上的MapPoints能被其它关键帧（至少3个）观测到，则认为是冗余关键帧。



### 7、将当前帧加入到闭环检测队列中

mpLoopCloser->InsertKeyFrame(mpCurrentKeyFrame);

LoopClosing闭环检测线程中会对新插入的关键帧做闭环检测操作。